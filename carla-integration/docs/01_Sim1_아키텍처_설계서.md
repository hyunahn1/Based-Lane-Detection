# Simulation 1: Traditional LKAS - 아키텍처 설계서

**날짜:** 2026-01-30  
**버전:** 1.0  
**목표:** CARLA 기반 Traditional Lane Keeping Assist System

---

## 1. 개요

### 1.1 목적
- **과제 필수 요구사항 충족**
- Module 01, 02, 03 통합
- CARLA 시뮬레이션 환경 구축
- 완전한 LKAS 시스템 구현

### 1.2 범위
- **환경:** CARLA Simulator
- **차량:** RC Car (Ackermann steering)
- **센서:** Camera (lane), Camera (object detection)
- **제어:** PID-based steering control
- **안전:** Warning system, obstacle avoidance

### 1.3 핵심 컴포넌트
1. **Module 01:** DeepLabV3+ Lane Detection
2. **Module 02:** PID Controller + Warning System
3. **Module 03:** YOLOv8 Object Detection
4. **CARLA Interface:** Sensor data & vehicle control

---

## 2. 시스템 아키텍처

### 2.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    CARLA Environment                         │
│  ┌────────────┐    ┌────────────┐    ┌────────────┐         │
│  │  Vehicle   │    │  Camera    │    │   Track    │         │
│  │  (RC Car)  │    │  Sensors   │    │  (World)   │         │
│  └──────┬─────┘    └──────┬─────┘    └────────────┘         │
└─────────┼────────────────┼────────────────────────────────┘
          │                │
          │ Control        │ Image Stream
          │                │
┌─────────▼────────────────▼────────────────────────────────┐
│              Integration Layer (Python)                    │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐        ┌──────────────┐                 │
│  │  Module 01   │        │  Module 03   │                 │
│  │    Lane      │        │   Object     │                 │
│  │  Detection   │        │  Detection   │                 │
│  └──────┬───────┘        └──────┬───────┘                 │
│         │                       │                          │
│         │ Lane Info             │ Objects Info            │
│         │                       │                          │
│         └───────────┬───────────┘                          │
│                     ▼                                       │
│              ┌──────────────┐                              │
│              │  Module 02   │                              │
│              │ Lane Keeping │                              │
│              │  + Warning   │                              │
│              └──────┬───────┘                              │
│                     │                                       │
│                     │ Steering Command                     │
│                     ▼                                       │
│              ┌──────────────┐                              │
│              │ Vehicle      │                              │
│              │ Control      │                              │
│              └──────────────┘                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 데이터 플로우

```
CARLA Camera → RGB Image (640×480)
    ↓
[Module 01] DeepLabV3+
    ↓
Lane Mask + Polyline
    ↓
[Lane Tracker] Extract center, offset, heading
    ↓
[Module 02] PID Controller
    ↓
Steering Angle + Warning Level
    ↓
CARLA Vehicle Control

병렬:
CARLA Camera → RGB Image
    ↓
[Module 03] YOLOv8
    ↓
Bounding Boxes (obstacles)
    ↓
[Safety Check] Emergency stop if collision risk
    ↓
Override steering if needed
```

---

## 3. CARLA 환경 설정

### 3.1 World Configuration

**맵:** Town01 or Custom RC Track

**차량:**
- Type: RC Car model (small vehicle)
- Physics: Ackermann steering
- Max speed: 3 m/s
- Max steering: ±45 degrees

**트랙:**
- Width: 1.5m
- Length: 50-100m
- Lane markings: White lines
- Obstacles: Traffic cones, boxes

### 3.2 센서 설정

#### Camera 1: Lane Detection
```yaml
type: sensor.camera.rgb
position: [0.5, 0.0, 0.3]  # Front center
rotation: [0, 0, 0]
resolution: 640x480
fov: 90
fps: 30
```

#### Camera 2: Object Detection (선택)
```yaml
type: sensor.camera.rgb
position: [0.5, 0.0, 0.3]  # Same as lane camera
resolution: 640x480
fov: 90
fps: 20  # Lower for efficiency
```

**Note:** 같은 카메라 공유 가능!

---

## 4. Module Integration

### 4.1 Module 01 통합 (Lane Detection)

**입력:**
- CARLA camera image (640×480 RGB)

**처리:**
```python
1. Image preprocessing (resize to 320×320)
2. DeepLabV3+ inference
3. Post-processing (morphology, CCA)
4. Polyline extraction
```

**출력:**
```python
{
    'lane_mask': np.ndarray,      # (480, 640)
    'lane_polyline': List[Point],  # [(x, y), ...]
    'confidence': float,           # 0.0-1.0
    'processing_time': float       # ms
}
```

### 4.2 Module 02 통합 (Lane Keeping)

**입력:**
- Lane polyline from Module 01
- Vehicle state (position, velocity, heading)

**처리:**
```python
1. Extract lateral offset
2. Calculate heading error
3. PID control computation
4. Risk level assessment
5. Warning generation
```

**출력:**
```python
{
    'steering_angle': float,      # -45 to +45 degrees
    'throttle': float,            # 0.0-1.0
    'risk_level': int,            # 0-5
    'warning': str,               # "SAFE", "CAUTION", etc.
    'should_intervene': bool
}
```

### 4.3 Module 03 통합 (Object Detection)

**입력:**
- CARLA camera image (640×480 RGB)

**처리:**
```python
1. YOLOv8 inference
2. NMS (Non-Maximum Suppression)
3. Distance estimation
4. Collision risk assessment
```

**출력:**
```python
{
    'objects': List[Detection],   # [{class, bbox, conf}, ...]
    'num_objects': int,
    'closest_object': Detection,  # Most critical
    'collision_risk': bool,
    'processing_time': float
}
```

---

## 5. 제어 로직

### 5.1 메인 루프 (30Hz)

```python
while simulation_running:
    # 1. Sensor data
    image = carla_camera.get_image()
    vehicle_state = carla_vehicle.get_state()
    
    # 2. Perception
    lane_info = module_01.detect(image)
    objects = module_03.detect(image)
    
    # 3. Decision
    control = module_02.compute_control(lane_info, vehicle_state)
    
    # 4. Safety check
    if objects['collision_risk']:
        control['steering_angle'] = emergency_steer
        control['throttle'] = 0.0
    
    # 5. Apply control
    carla_vehicle.apply_control(control)
    
    # 6. Visualization
    display_overlay(lane_info, objects, control)
```

### 5.2 우선순위

```
Priority 1: Safety (Module 03)
  → Collision risk → Emergency stop
  
Priority 2: Lane keeping (Module 02)
  → Lateral offset → PID steering
  
Priority 3: Speed control
  → Target speed maintenance
```

---

## 6. 성능 목표

### 6.1 Latency

| Component | Target | Max |
|-----------|--------|-----|
| Module 01 (Lane) | < 20ms | 30ms |
| Module 03 (Object) | < 30ms | 50ms |
| Module 02 (Control) | < 5ms | 10ms |
| Visualization | < 10ms | 20ms |
| **Total** | **< 65ms** | **110ms** |

**Target FPS:** 15-30 Hz

### 6.2 Control Accuracy

| Metric | Target |
|--------|--------|
| Lane center MAE | < 10cm |
| Heading error | < 5 degrees |
| Steering smoothness | < 2°/s² |
| False warning rate | < 5% |

### 6.3 Safety

| Metric | Requirement |
|--------|-------------|
| Collision avoidance | 100% |
| Emergency stop time | < 500ms |
| Fail-safe activation | < 100ms |

---

## 7. 기술 스택

### 7.1 Core

```python
CARLA 0.9.15
Python 3.10+
PyTorch 2.0+
OpenCV 4.9+
NumPy 1.24+
```

### 7.2 Existing Modules

```python
Module 01: /01-lane-detection/src/
Module 02: /02-lane-keeping-assist/src/
Module 03: /03-object-detection/src/
```

### 7.3 CARLA Python API

```python
carla.Client
carla.World
carla.Vehicle
carla.Sensor (Camera)
carla.VehicleControl
```

---

## 8. 디렉토리 구조

```
carla-integration/
├── docs/
│   ├── 01_Sim1_아키텍처_설계서.md    ← 이 파일
│   ├── 02_Sim1_구현_명세서.md
│   └── 03_Sim1_검증서.md
│
├── sim1-traditional/
│   ├── __init__.py
│   ├── main.py                    # 메인 실행
│   ├── carla_interface.py         # CARLA 연결
│   ├── lane_detector_node.py      # Module 01
│   ├── lane_keeper_node.py        # Module 02
│   ├── object_detector_node.py    # Module 03
│   ├── vehicle_controller.py      # 통합 제어
│   └── visualizer.py              # 시각화
│
├── carla_utils/
│   ├── __init__.py
│   ├── carla_client.py            # CARLA 클라이언트
│   ├── sensor_manager.py          # 센서 관리
│   └── world_setup.py             # World 설정
│
├── config/
│   └── sim1_config.yaml           # 설정 파일
│
├── tests/
│   └── test_sim1_integration.py   # 통합 테스트
│
└── README.md
```

---

## 9. 개발 일정

### Phase 1: 문서 (오늘~토요일)
- ✅ 아키텍처 설계서
- ✅ 구현 명세서
- ✅ 검증서

### Phase 2: 코드 (토요일~일요일)
- ✅ CARLA interface (GPU 불필요)
- ✅ Module 01, 02, 03 통합
- ✅ Dummy data로 테스트

### Phase 3: 실행 (월요일)
- ✅ CARLA 설치 & 실행
- ✅ 실제 테스트
- ✅ 디버깅
- ✅ Demo 녹화

---

## 10. 위험 요소

### 10.1 기술적 위험

| Risk | Impact | Mitigation |
|------|--------|------------|
| CARLA 설치 실패 | High | 사전 설치 가이드 |
| GPU 메모리 부족 | Medium | 배치 처리 최적화 |
| FPS 낮음 | Medium | 해상도 조정 |
| Module 호환 문제 | Low | 사전 테스트 |

### 10.2 일정 위험

| Risk | Impact | Mitigation |
|------|--------|------------|
| 월요일 시간 부족 | High | 주말 코드 완성 |
| 디버깅 오래 걸림 | Medium | 사전 로직 검증 |

---

**작성자:** AI Development Team  
**날짜:** 2026-01-30  
**Status:** Architecture Design Complete  
**Next:** Implementation Specification
