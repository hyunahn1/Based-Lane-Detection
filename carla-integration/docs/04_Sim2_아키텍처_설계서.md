# Simulation 2: End-to-End with ViT - 아키텍처 설계서

**날짜:** 2026-01-30  
**버전:** 1.0  
**목표:** CARLA 기반 Vision Transformer End-to-End Learning

---

## 1. 개요

### 1.1 목적
- **포트폴리오 차별화**
- Module 06 (E2E + ViT) CARLA 통합
- 최신 Transformer 기술 시연
- Camera → Control 직접 매핑

### 1.2 범위
- **환경:** CARLA Simulator
- **모델:** Vision Transformer (ViT)
- **입력:** RGB Camera Image
- **출력:** Steering + Throttle (직접)
- **특징:** Attention Visualization

### 1.3 핵심 차별점
```
Traditional (Sim 1):
  Camera → Lane Detection → PID → Control
  (Multi-stage, 수작업 feature)

End-to-End (Sim 2):
  Camera → ViT → Control
  (Single-stage, 학습된 feature)
```

---

## 2. 시스템 아키텍처

### 2.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    CARLA Environment                         │
│  ┌────────────┐    ┌────────────┐                           │
│  │  Vehicle   │    │  Camera    │                           │
│  │  (RC Car)  │    │  (RGB)     │                           │
│  └──────┬─────┘    └──────┬─────┘                           │
└─────────┼────────────────┼─────────────────────────────────┘
          │                │
          │ Control        │ Image (224×224)
          │                │
┌─────────▼────────────────▼─────────────────────────────────┐
│              Integration Layer                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│                   ┌──────────────────┐                      │
│                   │   Module 06      │                      │
│                   │  Vision ViT      │                      │
│                   │  End-to-End      │                      │
│                   └────────┬─────────┘                      │
│                            │                                 │
│                   ┌────────▼─────────┐                      │
│                   │ Patch Embedding  │                      │
│                   │   (16×16)        │                      │
│                   └────────┬─────────┘                      │
│                            │                                 │
│                   ┌────────▼─────────┐                      │
│                   │  Transformer     │                      │
│                   │  12 Layers       │                      │
│                   │  Multi-Head Attn │                      │
│                   └────────┬─────────┘                      │
│                            │                                 │
│                   ┌────────▼─────────┐                      │
│                   │  Control Head    │                      │
│                   │ Steering+Throttle│                      │
│                   └────────┬─────────┘                      │
│                            │                                 │
│                            ▼                                 │
│                   Steering: [-1, 1]                         │
│                   Throttle: [0, 1]                          │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 데이터 플로우

```
CARLA Camera → RGB (640×480)
    ↓ Resize
RGB (224×224)
    ↓ Patch Embedding
Patches (14×14, dim=768)
    ↓ Position Encoding
Tokens + Position
    ↓ Transformer (12 layers)
CLS Token Features (768-dim)
    ↓ Control Head
[Steering, Throttle]
    ↓
CARLA Vehicle Control
```

---

## 3. CARLA 환경 설정

### 3.1 World Configuration

**맵:** Town01 or Town02

**차량:**
- Type: Small vehicle
- Max speed: 3 m/s

**트랙:**
- Simple circuit
- Clear lane markings

### 3.2 센서 설정

#### Camera: RGB
```yaml
type: sensor.camera.rgb
position: [0.5, 0.0, 0.3]
rotation: [0, 0, 0]
resolution: 640x480  # Resize to 224×224
fov: 90
fps: 30
```

---

## 4. Module Integration

### 4.1 Module 06 통합 (E2E Model)

**입력:**
- CARLA camera image (640×480 RGB)

**처리:**
```python
1. Resize to 224×224
2. Normalize (ImageNet stats)
3. ViT inference
4. Control Head output
```

**출력:**
```python
{
    'steering': float,      # -1 to +1
    'throttle': float,      # 0 to 1
    'attention_maps': np.ndarray,  # For visualization
    'processing_time': float
}
```

### 4.2 Attention Visualization

**실시간 Attention Map:**
```
- Layer 12 attention weights
- Overlay on original image
- Show what model "sees"
```

---

## 5. 제어 로직

### 5.1 메인 루프 (30Hz)

```python
while simulation_running:
    # 1. Sensor data
    image = carla_camera.get_image()
    
    # 2. E2E inference
    control = e2e_model.predict(image)
    
    # 3. Apply control (direct!)
    carla_vehicle.apply_control(
        steering=control['steering'],
        throttle=control['throttle']
    )
    
    # 4. Visualization
    display_attention(control['attention_maps'])
```

### 5.2 Safety Override

```python
# Speed limit
if velocity > 5.0:
    throttle = 0.0

# Emergency stop (user input)
if emergency_button:
    steering = 0.0
    throttle = 0.0
```

---

## 6. 성능 목표

### 6.1 Latency

| Component | Target | Max |
|-----------|--------|-----|
| ViT Inference | < 30ms | 50ms |
| Visualization | < 10ms | 20ms |
| **Total** | **< 40ms** | **70ms** |

**Target FPS:** 20-30 Hz

### 6.2 Control Accuracy

| Metric | Target |
|--------|--------|
| Lane center MAE | < 15cm |
| Steering smoothness | High |
| Success rate | > 80% |

---

## 7. 기술 스택

### 7.1 Core

```python
CARLA 0.9.15
Python 3.10+
PyTorch 2.0+
einops 0.7+
timm 0.9+
```

### 7.2 Existing Modules

```python
Module 06: /06-end-to-end-learning/src/
  - VisionTransformer
  - ControlHead
  - EndToEndModel
```

---

## 8. 디렉토리 구조

```
carla-integration/
├── docs/
│   ├── 04_Sim2_아키텍처_설계서.md    ← 이 파일
│   ├── 05_Sim2_구현_명세서.md
│   └── 06_Sim2_검증서.md
│
├── sim2-e2e/
│   ├── __init__.py
│   ├── main.py                    # 메인 실행
│   ├── carla_interface.py         # CARLA 연결 (재사용)
│   ├── e2e_model_node.py          # Module 06 wrapper
│   ├── attention_visualizer.py    # Attention 시각화
│   └── config.yaml                # 설정
│
└── tests/
    └── test_sim2_integration.py
```

---

## 9. 개발 일정

### Phase 1: 문서 (토요일 오후)
- ✅ 아키텍처 설계서
- ✅ 구현 명세서
- ✅ 검증서

### Phase 2: 코드 (토요일 저녁)
- ✅ CARLA interface (재사용)
- ✅ Module 06 통합
- ✅ Attention visualization

### Phase 3: 실행 (월요일)
- ✅ CARLA 테스트
- ✅ Attention demo
- ✅ 영상 촬영

---

## 10. 특징 (Sim 1과 차이)

### Sim 1 (Traditional):
```
- Multi-stage pipeline
- Lane detection → PID
- Explainable (명시적)
- 안정적
```

### Sim 2 (E2E):
```
- Single-stage (end-to-end)
- Direct image → control
- Black-box (학습됨)
- 최신 기술 (Transformer)
- Attention visualization
```

---

**작성자:** AI Development Team  
**날짜:** 2026-01-30  
**Status:** Architecture Design Complete  
**Next:** Implementation Specification
