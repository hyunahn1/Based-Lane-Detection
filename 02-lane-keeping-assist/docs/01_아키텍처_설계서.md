# Module 02: Lane Keeping Assist System - 아키텍처 설계서

**버전:** 1.0  
**작성일:** 2026-01-30  
**상태:** 설계 단계

---

## 📋 목차

1. [시스템 개요](#1-시스템-개요)
2. [설계 철학](#2-설계-철학)
3. [시스템 아키텍처](#3-시스템-아키텍처)
4. [핵심 컴포넌트](#4-핵심-컴포넌트)
5. [데이터 플로우](#5-데이터-플로우)
6. [인터페이스 설계](#6-인터페이스-설계)
7. [기술 스택](#7-기술-스택)
8. [성능 목표](#8-성능-목표)
9. [보안 및 안전](#9-보안-및-안전)

---

## 1. 시스템 개요

### 1.1 목적

Module 01 (Lane Detection)의 출력을 기반으로 **차선 유지 보조 시스템(LKAS)**을 구현합니다. 차량이 차선을 벗어나지 않도록 실시간으로 모니터링하고, 필요 시 경고 및 자동 조향 개입을 수행합니다.

### 1.2 범위

**In Scope:**
- ✅ 차선 중심 추적 (Lane Center Tracking)
- ✅ 차선 이탈 감지 (Lane Departure Detection)
- ✅ 시각/청각 경고 시스템 (Warning System)
- ✅ PID 기반 조향 제어 (Steering Control)
- ✅ 안전 개입 메커니즘 (Safety Intervention)

**Out of Scope:**
- ❌ 차선 변경 보조 (Lane Change Assist)
- ❌ 충돌 회피 (Collision Avoidance) - Module 03에서 다룸
- ❌ 적응형 크루즈 컨트롤 (ACC)

### 1.3 시스템 요구사항

| 카테고리 | 요구사항 | 목표 값 |
|---------|---------|---------|
| **실시간성** | 제어 루프 주기 | < 50ms (20 Hz) |
| **정확도** | 차선 중심 추정 오차 | < 10cm |
| **응답성** | 차선 이탈 감지 시간 | < 100ms |
| **안정성** | 조향 각도 변화율 | < 5°/s |
| **안전성** | False Positive Rate | < 1% |

---

## 2. 설계 철학

### 2.1 핵심 원칙

1. **안전 최우선 (Safety First)**
   - 모든 개입은 점진적이고 예측 가능해야 함
   - 비상 상황 대응 메커니즘 필수
   - Fail-safe 설계

2. **독립성 (Modularity)**
   - Module 01과 느슨한 결합 (Loose Coupling)
   - 단독 실행 가능 (Standalone Operation)
   - 표준 인터페이스 제공

3. **확장성 (Extensibility)**
   - 다른 모듈과 쉽게 통합 가능
   - 플러그인 아키텍처
   - 설정 기반 동작 변경

4. **투명성 (Transparency)**
   - 모든 결정 과정 로깅
   - 실시간 모니터링 지원
   - 디버깅 용이성

---

## 3. 시스템 아키텍처

### 3.1 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                  Lane Keeping Assist System                  │
│                      (Module 02)                             │
└─────────────────────────────────────────────────────────────┘

┌──────────────┐
│   Input      │
│   (Camera    │
│   Image)     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Module 01: Lane Detection                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Output: lane_mask, lane_polyline, confidence         │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│  Module 02: Lane Keeping Assist                             │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  1. Lane Tracker                                       │ │
│  │     - 차선 중심선 추출                                   │ │
│  │     - 차량 위치 추정                                     │ │
│  │     - 횡방향 오프셋 계산                                 │ │
│  └────────────────┬───────────────────────────────────────┘ │
│                   │                                          │
│                   ▼                                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  2. Departure Detector                                 │ │
│  │     - 이탈 여부 판단                                     │ │
│  │     - 이탈 위험도 계산                                   │ │
│  │     - 시간 여유 추정 (TTC)                              │ │
│  └────────────────┬───────────────────────────────────────┘ │
│                   │                                          │
│         ┌─────────┴─────────┐                               │
│         │                   │                               │
│         ▼                   ▼                               │
│  ┌─────────────┐    ┌─────────────────┐                    │
│  │ 3. Warning  │    │ 4. Controller   │                    │
│  │    System   │    │    (PID)        │                    │
│  │  - 시각 경고 │    │  - 조향각 계산   │                    │
│  │  - 청각 경고 │    │  - 속도 조절     │                    │
│  │  - 햅틱 경고 │    │  - 개입 실행     │                    │
│  └─────────────┘    └─────────┬───────┘                    │
│                               │                             │
└───────────────────────────────┼─────────────────────────────┘
                                │
                                ▼
                        ┌───────────────┐
                        │  Vehicle      │
                        │  Actuators    │
                        │  (Steering)   │
                        └───────────────┘
```

### 3.2 레이어 구조

```
┌─────────────────────────────────────────┐
│  Application Layer                       │
│  - main.py                               │
│  - CLI interface                         │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Business Logic Layer                    │
│  - LaneKeepingAssist (Orchestrator)     │
│  - State Machine                         │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Component Layer                         │
│  - LaneTracker                           │
│  - DepartureDetector                     │
│  - WarningSystem                         │
│  - SteeringController                    │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Utility Layer                           │
│  - Geometry utilities                    │
│  - Visualization                         │
│  - Logging                               │
└─────────────────────────────────────────┘
```

---

## 4. 핵심 컴포넌트

### 4.1 Lane Tracker (차선 추적기)

**책임 (Responsibility):**
- Module 01의 polyline을 분석하여 차선 중심선 추출
- 차량의 현재 위치(횡방향 오프셋) 계산
- 차선 곡률(curvature) 추정

**입력:**
```python
{
    "lane_polyline": List[Tuple[float, float]],  # (x, y) 좌표
    "vehicle_position": Tuple[float, float],      # 차량 중심 위치
    "image_shape": Tuple[int, int]                # (height, width)
}
```

**출력:**
```python
{
    "lane_center": List[Tuple[float, float]],    # 중심선
    "lateral_offset": float,                      # 횡방향 오프셋 (m)
    "heading_error": float,                       # 헤딩 오차 (degree)
    "curvature": float,                           # 곡률 (1/m)
    "is_valid": bool                              # 추적 유효성
}
```

**알고리즘:**
1. Polyline 스무딩 (Moving Average, Savitzky-Golay Filter)
2. 차량 좌표계로 변환 (Coordinate Transformation)
3. 최근접점 탐색 (Nearest Point on Curve)
4. 횡방향 거리 계산 (Cross-Track Error)
5. 헤딩 오차 계산 (Heading Error)

### 4.2 Departure Detector (이탈 감지기)

**책임:**
- 차선 이탈 여부 실시간 판단
- 이탈 위험도 레벨 계산
- Time To Crossing (TTC) 추정

**입력:**
```python
{
    "lateral_offset": float,
    "heading_error": float,
    "vehicle_speed": float,
    "lane_width": float
}
```

**출력:**
```python
{
    "is_departing": bool,
    "risk_level": int,  # 0-5 (0=safe, 5=critical)
    "time_to_crossing": float,  # seconds
    "departure_side": str  # "left", "right", "none"
}
```

**임계값 설정:**
| 레벨 | 횡방향 오프셋 | 헤딩 오차 | 동작 |
|------|--------------|----------|------|
| 0 (Safe) | < 0.2m | < 3° | 없음 |
| 1 (Normal) | 0.2-0.4m | 3-5° | 모니터링 |
| 2 (Caution) | 0.4-0.6m | 5-10° | 시각 경고 |
| 3 (Warning) | 0.6-0.8m | 10-15° | 청각 경고 |
| 4 (Critical) | 0.8-1.0m | 15-20° | 햅틱 경고 + 개입 준비 |
| 5 (Emergency) | > 1.0m | > 20° | 즉시 개입 |

### 4.3 Warning System (경고 시스템)

**책임:**
- 위험도에 따른 다단계 경고
- 운전자 주의 환기
- 경고 히스토리 관리

**경고 타입:**

1. **시각 경고 (Visual Warning)**
   ```python
   - Level 2: 노란색 차선 표시
   - Level 3: 주황색 깜빡임
   - Level 4: 빨간색 깜빡임 + 텍스트 "LANE DEPARTURE!"
   - Level 5: 전체 화면 빨간색 깜빡임
   ```

2. **청각 경고 (Auditory Warning)**
   ```python
   - Level 3: 부드러운 비프음 (1회)
   - Level 4: 반복 비프음 (2회)
   - Level 5: 긴급 경보음 (연속)
   ```

3. **햅틱 경고 (Haptic Warning)** - 향후 확장
   ```python
   - 조향 휠 진동
   - 차등 진동 (이탈 방향 표시)
   ```

### 4.4 Steering Controller (조향 제어기)

**책임:**
- PID 제어로 조향각 계산
- 부드러운 개입 (Smooth Intervention)
- 안전 제약 조건 만족

**PID 제어기 설계:**

```
Control Signal = Kp * error + Ki * ∫error dt + Kd * d(error)/dt

where:
  error = lateral_offset + K_heading * heading_error
  
Parameters (초기값):
  Kp = 0.5  (비례 게인)
  Ki = 0.1  (적분 게인)
  Kd = 0.2  (미분 게인)
  K_heading = 0.3  (헤딩 가중치)
```

**안전 제약:**
- 최대 조향각: ±30°
- 최대 조향 속도: 5°/s
- Saturation 및 Anti-windup 적용

**입력:**
```python
{
    "lateral_offset": float,
    "heading_error": float,
    "curvature": float,
    "vehicle_speed": float,
    "dt": float  # 시간 간격
}
```

**출력:**
```python
{
    "steering_angle": float,  # degree
    "throttle_adjustment": float,  # -1.0 ~ 1.0
    "confidence": float  # 0.0 ~ 1.0
}
```

---

## 5. 데이터 플로우

### 5.1 실시간 처리 파이프라인

```
Time: t=0ms
┌─────────────────┐
│ Camera Frame    │
└────────┬────────┘
         │
         ▼  (10ms)
┌─────────────────┐
│ Module 01:      │
│ Lane Detection  │
└────────┬────────┘
         │
         ▼  (5ms)
┌─────────────────┐
│ Lane Tracker    │
│ - Center calc   │
│ - Offset calc   │
└────────┬────────┘
         │
         ▼  (2ms)
┌─────────────────┐
│ Departure       │
│ Detector        │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼  (3ms each)
┌────────┐ ┌─────────┐
│Warning │ │Controller│
│System  │ │(PID)    │
└────────┘ └────┬────┘
                │
                ▼  (5ms)
         ┌─────────────┐
         │  Actuator   │
         │  Command    │
         └─────────────┘

Total Latency: ~25ms (40 Hz)
```

### 5.2 상태 머신 (State Machine)

```
┌──────────┐
│   IDLE   │ ← 시스템 대기
└────┬─────┘
     │ lane detected
     ▼
┌──────────┐
│ TRACKING │ ← 정상 추적
└────┬─────┘
     │ departure detected (Level 2-3)
     ▼
┌──────────┐
│ WARNING  │ ← 경고 발생
└────┬─────┘
     │ risk escalates (Level 4-5)
     ▼
┌──────────┐
│INTERVENE │ ← 능동 개입
└────┬─────┘
     │ back to safe
     ▼
┌──────────┐
│RECOVERY  │ ← 복구 중
└────┬─────┘
     │ stabilized
     ▼
┌──────────┐
│ TRACKING │
└──────────┘
```

---

## 6. 인터페이스 설계

### 6.1 External Interface (Module 01 연동)

**Input Interface:**
```python
class LaneDetectionInput:
    """Module 01 출력 형식"""
    lane_mask: np.ndarray           # (H, W) binary mask
    lane_polyline: List[Point2D]    # centerline points
    confidence: float               # 0.0 ~ 1.0
    timestamp: float                # Unix timestamp
    metadata: Dict[str, Any]        # 추가 정보
```

**Output Interface:**
```python
class LKASOutput:
    """Module 02 출력 형식"""
    steering_angle: float           # 조향각 (degree)
    throttle_adjustment: float      # 스로틀 조정 (-1.0 ~ 1.0)
    warning_level: int              # 경고 레벨 (0-5)
    is_intervening: bool            # 개입 여부
    lateral_offset: float           # 횡방향 오프셋 (m)
    heading_error: float            # 헤딩 오차 (degree)
    timestamp: float
```

### 6.2 Configuration Interface

**설정 파일: `config/lkas_params.yaml`**
```yaml
# Tracking Parameters
tracking:
  smoothing_window: 5
  min_confidence: 0.5
  max_lateral_offset: 1.5  # meters

# Departure Detection
departure:
  risk_thresholds:
    level_2: 0.4  # meters
    level_3: 0.6
    level_4: 0.8
    level_5: 1.0
  heading_thresholds:
    level_2: 5.0   # degrees
    level_3: 10.0
    level_4: 15.0
    level_5: 20.0

# PID Controller
controller:
  kp: 0.5
  ki: 0.1
  kd: 0.2
  k_heading: 0.3
  max_steering_angle: 30.0  # degrees
  max_steering_rate: 5.0    # deg/s

# Warning System
warning:
  enable_visual: true
  enable_audio: true
  enable_haptic: false

# Safety Limits
safety:
  max_intervention_duration: 5.0  # seconds
  min_speed_for_lkas: 15.0       # km/h
  emergency_brake_threshold: 1.2  # meters
```

### 6.3 API Interface

```python
class LaneKeepingAssist:
    """Main LKAS API"""
    
    def __init__(self, config_path: str):
        """Initialize LKAS with configuration"""
        pass
    
    def process_frame(
        self, 
        lane_detection: LaneDetectionInput,
        vehicle_state: VehicleState
    ) -> LKASOutput:
        """
        Process single frame
        
        Args:
            lane_detection: Output from Module 01
            vehicle_state: Current vehicle state (speed, yaw, etc.)
        
        Returns:
            LKASOutput: Control commands and status
        """
        pass
    
    def update_parameters(self, params: Dict[str, Any]):
        """Dynamically update PID parameters"""
        pass
    
    def get_telemetry(self) -> Dict[str, Any]:
        """Get real-time telemetry data"""
        pass
    
    def reset(self):
        """Reset internal state"""
        pass
```

---

## 7. 기술 스택

### 7.1 핵심 라이브러리

| 컴포넌트 | 라이브러리 | 버전 | 용도 |
|---------|----------|------|------|
| **수치 계산** | NumPy | ≥1.24 | 행렬 연산, 좌표 변환 |
| **기하학** | Shapely | ≥2.0 | 차선 기하 연산 |
| **제어** | scipy | ≥1.10 | PID 제어, 필터링 |
| **시각화** | OpenCV | ≥4.8 | 경고 오버레이, 디버깅 |
| **설정** | PyYAML | ≥6.0 | 설정 파일 파싱 |
| **로깅** | loguru | ≥0.7 | 구조화된 로깅 |

### 7.2 개발 환경

- **Python:** 3.10+
- **OS:** Linux (Ubuntu 22.04), macOS, Windows
- **IDE:** VS Code, PyCharm
- **Version Control:** Git
- **Testing:** pytest, pytest-cov
- **CI/CD:** GitHub Actions

### 7.3 의존성 관리

```
requirements.txt:
  - numpy>=1.24.0
  - scipy>=1.10.0
  - opencv-python>=4.8.0
  - shapely>=2.0.0
  - pyyaml>=6.0
  - loguru>=0.7.0

dev-requirements.txt:
  - pytest>=7.4.0
  - pytest-cov>=4.1.0
  - black>=23.0.0
  - flake8>=6.0.0
  - mypy>=1.5.0
```

---

## 8. 성능 목표

### 8.1 정량적 목표 (KPI)

| 메트릭 | 목표 | 측정 방법 |
|--------|------|-----------|
| **처리 지연시간** | < 25ms | Frame-to-command time |
| **차선 중심 추정 정확도** | MAE < 10cm | 실측 데이터 대비 |
| **이탈 감지 정확도** | Precision > 95% | TP / (TP + FP) |
| **이탈 감지 재현율** | Recall > 98% | TP / (TP + FN) |
| **False Warning Rate** | < 1 per 100km | 실주행 테스트 |
| **조향 안정성** | Jerk < 2°/s² | 조향각 2차 미분 |
| **CPU 사용률** | < 30% | 단일 코어 기준 |
| **메모리 사용량** | < 100MB | 상주 메모리 |

### 8.2 정성적 목표

- ✅ **부드러운 제어:** 사용자가 거부감 없는 자연스러운 개입
- ✅ **예측 가능성:** 운전자가 시스템 동작 예측 가능
- ✅ **투명성:** 모든 결정 과정 추적 가능
- ✅ **강건성:** 다양한 도로/날씨 조건에서 안정적 동작

### 8.3 벤치마크

**비교 대상:**
- OpenPilot (comma.ai)
- Tesla Autopilot Lane Keep
- 상용 LKAS 시스템

**평가 시나리오:**
1. 직선 도로 (고속도로)
2. 완만한 곡선 (반경 > 500m)
3. 급커브 (반경 100-500m)
4. 차선 희미한 구간
5. 차선 공사 구간

---

## 9. 보안 및 안전

### 9.1 안전 메커니즘

**Fail-Safe 설계:**
```python
1. Input Validation
   - 차선 검출 신뢰도 체크 (confidence > threshold)
   - 센서 데이터 일관성 검증
   - 이상치 필터링

2. Watchdog Timer
   - 30ms 내 응답 없으면 안전 모드 진입
   - 제어 권한 운전자에게 즉시 반환

3. Graceful Degradation
   - Module 01 실패 시: 경고만 유지, 개입 중단
   - 센서 이상 시: 즉시 개입 중단, 경고 발생

4. Emergency Override
   - 운전자 조향 입력 감지 시 즉시 제어 반환
   - 브레이크 입력 시 시스템 일시 정지
```

### 9.2 테스트 전략

**단위 테스트 (Unit Test):**
- 각 컴포넌트 독립 테스트
- Edge case 커버리지 > 90%

**통합 테스트 (Integration Test):**
- 전체 파이프라인 E2E 테스트
- 시뮬레이션 환경 (CARLA/Gazebo)

**성능 테스트 (Performance Test):**
- 처리 시간 프로파일링
- 메모리 누수 검사
- 장시간 안정성 테스트

**안전 테스트 (Safety Test):**
- Fault Injection Testing
- 비상 시나리오 대응
- Regression Testing

### 9.3 로깅 및 모니터링

**로그 레벨:**
```python
DEBUG:   세부 추적 정보 (개발용)
INFO:    일반 동작 상태
WARNING: 비정상이지만 복구 가능
ERROR:   기능 실패
CRITICAL: 시스템 중단 필요
```

**모니터링 대시보드:**
- 실시간 차선 추적 상태
- 이탈 위험도 그래프
- 제어 신호 (조향각, 스로틀)
- 경고 히스토리
- 성능 메트릭 (FPS, latency)

---

## 10. 마일스톤 및 일정

### Phase 1: 기본 구현 (1-2일)
- [ ] Lane Tracker 구현
- [ ] Departure Detector 구현
- [ ] 단위 테스트 작성

### Phase 2: 제어 시스템 (2-3일)
- [ ] PID Controller 구현
- [ ] 안전 제약 적용
- [ ] 파라미터 튜닝

### Phase 3: 경고 시스템 (1-2일)
- [ ] 시각 경고 구현
- [ ] 청각 경고 구현
- [ ] 통합 테스트

### Phase 4: 통합 및 최적화 (2-3일)
- [ ] Module 01 연동
- [ ] 성능 최적화
- [ ] 실차/시뮬레이션 테스트

**총 예상 기간:** 1주 (6-10일)

---

## 11. 참고 자료

### 학술 논문
1. Rajamani, R. (2011). *Vehicle Dynamics and Control*. Springer.
2. Paden, B., et al. (2016). "A Survey of Motion Planning and Control Techniques for Self-driving Urban Vehicles." IEEE T-IV.
3. Schwarting, W., et al. (2018). "Planning and Decision-Making for Autonomous Vehicles." Annual Review of Control, Robotics, and Autonomous Systems.

### 산업 표준
- ISO 11270: Lane Keeping Assistance Systems
- SAE J3016: Taxonomy of Automated Driving
- ISO 26262: Functional Safety for Road Vehicles

### 오픈소스 참고
- OpenPilot: https://github.com/commaai/openpilot
- Autoware: https://github.com/autowarefoundation/autoware
- Apollo: https://github.com/ApolloAuto/apollo

---

**문서 버전 이력:**
- v1.0 (2026-01-30): 초안 작성

**리뷰어:** [TBD]  
**승인자:** [TBD]
